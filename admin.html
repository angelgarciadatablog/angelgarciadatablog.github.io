<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Panel - angelgarciadatablog</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    body {
      padding: 2rem 0;
    }

    .admin-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .admin-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .admin-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .admin-subtitle {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .admin-grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .admin-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .admin-card:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .card-icon {
      font-size: 2rem;
      flex-shrink: 0;
    }

    .card-info {
      flex: 1;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .card-description {
      color: var(--text-secondary);
      font-size: 0.875rem;
      line-height: 1.5;
      margin-bottom: 1rem;
    }

    .card-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn-action {
      background: var(--gradient);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn-action:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
    }

    .btn-action:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: transparent;
      border: 2px solid transparent;
      background-image:
        linear-gradient(var(--card-bg), var(--card-bg)),
        linear-gradient(90deg, #2674ed 0%, #7c3aed 50%, #ec4899 100%);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      color: var(--text);
    }

    .status-message {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.875rem;
      display: none;
    }

    .status-message.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    .status-success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .status-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .status-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .log-output {
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      color: #a3a3a3;
      display: none;
    }

    .log-output.show {
      display: block;
    }

    .log-line {
      margin-bottom: 0.25rem;
    }

    .log-success {
      color: #22c55e;
    }

    .log-error {
      color: #ef4444;
    }

    .log-info {
      color: #3b82f6;
    }

    .back-link {
      display: inline-block;
      margin-top: 2rem;
      color: var(--accent);
      text-decoration: none;
      font-size: 0.875rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .admin-title {
        font-size: 1.5rem;
      }

      .card-header {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1 class="admin-title">üîß Panel de Administraci√≥n</h1>
      <p class="admin-subtitle">Gestiona el contenido y cach√© de tu sitio web</p>
    </div>

    <div class="admin-grid">
      <!-- Limpiar Cach√© -->
      <div class="admin-card">
        <div class="card-header">
          <div class="card-icon">üóëÔ∏è</div>
          <div class="card-info">
            <h2 class="card-title">Limpiar Cach√©</h2>
            <p class="card-description">
              Limpia el cach√© de Google Sheets para forzar la actualizaci√≥n de cursos gratuitos, recursos de Notion y videos importantes.
            </p>
            <div class="card-meta">
              <span class="meta-item">‚è∞ Duraci√≥n actual: <strong id="cache-duration">60 minutos</strong></span>
              <span class="meta-item">üì¶ En cach√©: <strong id="cached-count">-</strong></span>
            </div>
          </div>
        </div>
        <button class="btn-action" onclick="clearCache()">Limpiar Todo el Cach√©</button>
        <div class="status-message status-success" id="cache-status"></div>
      </div>

      <!-- Actualizar Videos Recientes -->
      <div class="admin-card">
        <div class="card-header">
          <div class="card-icon">üé¨</div>
          <div class="card-info">
            <h2 class="card-title">Actualizar Videos Recientes</h2>
            <p class="card-description">
              Ejecuta el script local para obtener los 3 videos m√°s recientes y actualizar datos/videos-recientes.json directamente. Luego solo necesitas hacer commit.
            </p>
            <div class="card-meta">
              <span class="meta-item">üí∞ Costo: ~1 unidad de API</span>
              <span class="meta-item">üìÑ Actualiza: datos/videos-recientes.json</span>
              <span class="meta-item">ü§ñ Autom√°tico: GitHub Actions cada d√≠a a las 9 AM</span>
            </div>
          </div>
        </div>
        <button class="btn-action" onclick="updateRecentVideosLocal()" id="btn-recent-videos">Actualizar Videos Recientes</button>
        <div class="status-message" id="recent-videos-status"></div>
        <div class="log-output" id="recent-videos-log"></div>
      </div>

      <!-- Actualizar Playlists -->
      <div class="admin-card">
        <div class="card-header">
          <div class="card-icon">üì∫</div>
          <div class="card-info">
            <h2 class="card-title">Actualizar Playlists del Canal</h2>
            <p class="card-description">
              Obtiene todas las playlists de tu canal de YouTube y genera el archivo JSON para la p√°gina de listas de reproducci√≥n.
            </p>
            <div class="card-meta">
              <span class="meta-item">üí∞ Costo: ~1 unidad de API</span>
              <span class="meta-item">üìÑ Genera: tutoriales-playlists.json</span>
            </div>
          </div>
        </div>
        <button class="btn-action" onclick="fetchAllPlaylists()" id="btn-playlists">Actualizar Playlists</button>
        <div class="status-message" id="playlists-status"></div>
        <div class="log-output" id="playlists-log"></div>
      </div>

      <!-- Actualizar Curso SQL -->
      <div class="admin-card">
        <div class="card-header">
          <div class="card-icon">üéì</div>
          <div class="card-info">
            <h2 class="card-title">Actualizar Curso de SQL</h2>
            <p class="card-description">
              Actualiza todos los m√≥dulos del curso de SQL en BigQuery con informaci√≥n detallada de videos (vistas, likes, duraci√≥n).
            </p>
            <div class="card-meta">
              <span class="meta-item">üí∞ Costo: ~3 unidades/m√≥dulo</span>
              <span class="meta-item">üìÑ Actualiza: sql-bigquery-playlist.json</span>
            </div>
          </div>
        </div>
        <button class="btn-action" onclick="updateCourse('sql-bigquery')" id="btn-sql">Actualizar SQL</button>
        <div class="status-message" id="sql-status"></div>
        <div class="log-output" id="sql-log"></div>
      </div>

      <!-- Actualizar Curso Power BI -->
      <div class="admin-card">
        <div class="card-header">
          <div class="card-icon">üìä</div>
          <div class="card-info">
            <h2 class="card-title">Actualizar Curso de Power BI</h2>
            <p class="card-description">
              Actualiza el curso de Power BI - DAX con informaci√≥n detallada de videos.
            </p>
            <div class="card-meta">
              <span class="meta-item">üí∞ Costo: ~3 unidades/m√≥dulo</span>
              <span class="meta-item">üìÑ Actualiza: power-bi-playlist.json</span>
            </div>
          </div>
        </div>
        <button class="btn-action" onclick="updateCourse('power-bi')" id="btn-powerbi">Actualizar Power BI</button>
        <div class="status-message" id="powerbi-status"></div>
        <div class="log-output" id="powerbi-log"></div>
      </div>

      <!-- Actualizar Curso Google Analytics -->
      <div class="admin-card">
        <div class="card-header">
          <div class="card-icon">üìà</div>
          <div class="card-info">
            <h2 class="card-title">Actualizar Curso de Google Analytics</h2>
            <p class="card-description">
              Actualiza el curso de Google Analytics 4 con informaci√≥n detallada de videos.
            </p>
            <div class="card-meta">
              <span class="meta-item">üí∞ Costo: ~3 unidades/m√≥dulo</span>
              <span class="meta-item">üìÑ Actualiza: google-analytics-playlist.json</span>
            </div>
          </div>
        </div>
        <button class="btn-action" onclick="updateCourse('google-analytics')" id="btn-ga">Actualizar Google Analytics</button>
        <div class="status-message" id="ga-status"></div>
        <div class="log-output" id="ga-log"></div>
      </div>

      <!-- Actualizar TODOS los Cursos -->
      <div class="admin-card" style="border: 2px solid var(--accent);">
        <div class="card-header">
          <div class="card-icon">üöÄ</div>
          <div class="card-info">
            <h2 class="card-title">Actualizar Todos los Cursos</h2>
            <p class="card-description">
              Ejecuta la actualizaci√≥n de TODOS los cursos en secuencia. Esto puede tardar varios minutos.
            </p>
            <div class="card-meta">
              <span class="meta-item">üí∞ Costo total: ~9-15 unidades de API</span>
              <span class="meta-item">‚è±Ô∏è Duraci√≥n: 2-5 minutos</span>
            </div>
          </div>
        </div>
        <button class="btn-action btn-secondary" onclick="updateAllCourses()" id="btn-all">Actualizar Todo</button>
        <div class="status-message" id="all-status"></div>
        <div class="log-output" id="all-log"></div>
      </div>
    </div>

    <a href="index.html" class="back-link">‚Üê Volver al inicio</a>
  </div>

  <script src="js/googleSheets.js"></script>
  <script>
    const CLOUD_FUNCTION_URL = 'https://getyoutubevideos-35759247090.us-central1.run.app';

    // Cargar config de cursos
    const CURSOS_CONFIG = {
      "sql-bigquery": {
        titulo: "SQL en BigQuery",
        outputFile: "datos/sql-bigquery-playlist.json",
        modulos: [
          { moduloId: 1, playlistId: "PLV4oS06_KpqbnahoXdN-A8Ql9zVblYUJl" },
          { moduloId: 2, playlistId: "PLV4oS06_KpqY-NCxlYCYMPENL0EUTLNuU" }
        ]
      },
      "power-bi": {
        titulo: "Power BI - DAX",
        outputFile: "datos/power-bi-playlist.json",
        modulos: [
          { moduloId: 1, playlistId: "PLV4oS06_KpqZREyUB473G07o-IsM7n-fi" }
        ]
      },
      "google-analytics": {
        titulo: "Google Analytics 4",
        outputFile: "datos/google-analytics-playlist.json",
        modulos: [
          { moduloId: 1, playlistId: "PLV4oS06_KpqaJurJFbLi3HGrHrlOShc_x" }
        ]
      }
    };

    // Actualizar info del cach√©
    function updateCacheInfo() {
      const info = GoogleSheets.getCacheInfo();
      document.getElementById('cache-duration').textContent = info.cacheDuration;
      document.getElementById('cached-count').textContent =
        info.cachedSheets.length > 0 ? `${info.cachedSheets.length} pesta√±as` : 'Ninguna';
    }

    // Limpiar cach√©
    function clearCache() {
      const statusEl = document.getElementById('cache-status');
      GoogleSheets.clearCache();

      statusEl.textContent = '‚úÖ Cach√© limpiado exitosamente';
      statusEl.className = 'status-message status-success show';
      setTimeout(() => statusEl.classList.remove('show'), 5000);

      updateCacheInfo();
    }

    // Helper: Mostrar log
    function addLog(logId, message, type = 'info') {
      const logEl = document.getElementById(logId);
      logEl.classList.add('show');
      const line = document.createElement('div');
      line.className = `log-line log-${type}`;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Helper: Mostrar estado
    function showStatus(statusId, message, type) {
      const statusEl = document.getElementById(statusId);
      statusEl.textContent = message;
      statusEl.className = `status-message status-${type} show`;
      setTimeout(() => statusEl.classList.remove('show'), 8000);
    }

    // Helper: Descargar JSON
    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Update recent videos using local Node.js script
    async function updateRecentVideosLocal() {
      const btn = document.getElementById('btn-recent-videos');
      const statusId = 'recent-videos-status';
      const logId = 'recent-videos-log';

      document.getElementById(logId).innerHTML = '';
      btn.disabled = true;
      btn.textContent = 'üîÑ Ejecutando script...';

      addLog(logId, 'üöÄ Ejecutando: node scripts/update-videos-recientes.js', 'info');
      addLog(logId, 'üì° Llamando a Cloud Function...', 'info');

      try {
        // Obtener videos desde Cloud Function
        const url = `${CLOUD_FUNCTION_URL}?action=getRecentVideos&maxResults=3`;
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Error desconocido');
        }

        const videos = result.data;
        addLog(logId, `‚úÖ ${videos.length} videos obtenidos desde YouTube`, 'success');

        // Transformar datos al formato esperado
        const videosFormatted = videos.map(video => ({
          id: video.id,
          title: video.title,
          url: `https://www.youtube.com/watch?v=${video.id}`,
          thumbnail: video.thumbnail,
          publishedAt: video.publishedAt,
          description: video.description || ''
        }));

        // Preparar JSON
        const output = {
          fechaActualizacion: new Date().toISOString(),
          totalVideos: videosFormatted.length,
          videos: videosFormatted
        };

        // Mostrar videos obtenidos
        addLog(logId, '\nüìä Videos actualizados:', 'info');
        videosFormatted.forEach((video, i) => {
          addLog(logId, `  ${i + 1}. ${video.title}`, 'info');
        });

        // Crear contenido del archivo para copiar
        const jsonContent = JSON.stringify(output, null, 2);

        // Copiar al clipboard
        await navigator.clipboard.writeText(jsonContent);
        addLog(logId, '\n‚úÖ JSON copiado al portapapeles', 'success');
        addLog(logId, '\nüìù Pasos siguientes:', 'info');
        addLog(logId, '  1. Abre: datos/videos-recientes.json', 'info');
        addLog(logId, '  2. Pega el contenido (Cmd+V / Ctrl+V)', 'info');
        addLog(logId, '  3. Guarda el archivo (Cmd+S / Ctrl+S)', 'info');
        addLog(logId, '  4. Haz commit: git add datos/videos-recientes.json', 'info');
        addLog(logId, '  5. git commit -m "Update: Videos recientes"', 'info');

        showStatus(statusId, `‚úÖ ${videosFormatted.length} videos actualizados. JSON copiado al portapapeles.`, 'success');

      } catch (error) {
        addLog(logId, `‚úó Error: ${error.message}`, 'error');
        showStatus(statusId, `‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Actualizar Videos Recientes';
      }
    }

    // Fetch all playlists
    async function fetchAllPlaylists() {
      const btn = document.getElementById('btn-playlists');
      const statusId = 'playlists-status';
      const logId = 'playlists-log';

      document.getElementById(logId).innerHTML = '';
      btn.disabled = true;
      btn.textContent = 'üîÑ Obteniendo playlists...';

      addLog(logId, 'Llamando a Cloud Function...', 'info');

      try {
        const url = `${CLOUD_FUNCTION_URL}?action=listPlaylists&maxResults=50`;
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Error desconocido');
        }

        const playlists = result.data;
        addLog(logId, `‚úì ${playlists.length} playlists obtenidas`, 'success');

        // Preparar JSON
        const output = {
          fechaActualizacion: new Date().toISOString(),
          totalPlaylists: playlists.length,
          playlists: playlists
        };

        // Descargar archivo
        downloadJSON('tutoriales-playlists.json', output);
        addLog(logId, `‚úì Archivo descargado: tutoriales-playlists.json`, 'success');

        showStatus(statusId, `‚úÖ ${playlists.length} playlists actualizadas. Archivo descargado.`, 'success');

      } catch (error) {
        addLog(logId, `‚úó Error: ${error.message}`, 'error');
        showStatus(statusId, `‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Actualizar Playlists';
      }
    }

    // Update course
    async function updateCourse(courseId) {
      const config = CURSOS_CONFIG[courseId];
      const btn = document.getElementById(`btn-${courseId === 'sql-bigquery' ? 'sql' : courseId === 'power-bi' ? 'powerbi' : 'ga'}`);
      const statusId = `${courseId === 'sql-bigquery' ? 'sql' : courseId === 'power-bi' ? 'powerbi' : 'ga'}-status`;
      const logId = `${courseId === 'sql-bigquery' ? 'sql' : courseId === 'power-bi' ? 'powerbi' : 'ga'}-log`;

      document.getElementById(logId).innerHTML = '';
      btn.disabled = true;
      btn.textContent = 'üîÑ Actualizando...';

      addLog(logId, `Iniciando actualizaci√≥n de ${config.titulo}...`, 'info');

      try {
        const modulos = [];

        for (const modulo of config.modulos) {
          addLog(logId, `Obteniendo m√≥dulo ${modulo.moduloId}...`, 'info');

          const url = `${CLOUD_FUNCTION_URL}?action=getPlaylistWithDetails&playlistId=${modulo.playlistId}`;
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status} en m√≥dulo ${modulo.moduloId}`);
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || `Error en m√≥dulo ${modulo.moduloId}`);
          }

          modulos.push({
            moduloId: modulo.moduloId,
            ...result.data
          });

          addLog(logId, `‚úì M√≥dulo ${modulo.moduloId}: ${result.data.videos.length} videos`, 'success');
        }

        // Preparar JSON
        const output = {
          fechaActualizacion: new Date().toISOString(),
          curso: config.titulo,
          modulos: modulos
        };

        // Descargar archivo
        const filename = config.outputFile.split('/')[1];
        downloadJSON(filename, output);
        addLog(logId, `‚úì Archivo descargado: ${filename}`, 'success');

        showStatus(statusId, `‚úÖ ${config.titulo} actualizado. Archivo descargado.`, 'success');

      } catch (error) {
        addLog(logId, `‚úó Error: ${error.message}`, 'error');
        showStatus(statusId, `‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = `Actualizar ${config.titulo.split(' ')[0]}`;
      }
    }

    // Update all courses
    async function updateAllCourses() {
      const btn = document.getElementById('btn-all');
      const statusId = 'all-status';
      const logId = 'all-log';

      document.getElementById(logId).innerHTML = '';
      btn.disabled = true;
      btn.textContent = 'üîÑ Actualizando todos...';

      addLog(logId, 'Iniciando actualizaci√≥n de todos los cursos...', 'info');

      try {
        for (const [courseId, config] of Object.entries(CURSOS_CONFIG)) {
          addLog(logId, `\nüìö Procesando ${config.titulo}...`, 'info');

          const modulos = [];

          for (const modulo of config.modulos) {
            addLog(logId, `  M√≥dulo ${modulo.moduloId}...`, 'info');

            const url = `${CLOUD_FUNCTION_URL}?action=getPlaylistWithDetails&playlistId=${modulo.playlistId}`;
            const response = await fetch(url);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status} en ${config.titulo} m√≥dulo ${modulo.moduloId}`);
            }

            const result = await response.json();

            if (!result.success) {
              throw new Error(`Error en ${config.titulo} m√≥dulo ${modulo.moduloId}`);
            }

            modulos.push({
              moduloId: modulo.moduloId,
              ...result.data
            });

            addLog(logId, `  ‚úì ${result.data.videos.length} videos`, 'success');
          }

          const output = {
            fechaActualizacion: new Date().toISOString(),
            curso: config.titulo,
            modulos: modulos
          };

          const filename = config.outputFile.split('/')[1];
          downloadJSON(filename, output);
          addLog(logId, `‚úì ${filename} descargado`, 'success');
        }

        addLog(logId, '\n‚úì ¬°Todos los cursos actualizados!', 'success');
        showStatus(statusId, '‚úÖ Todos los cursos actualizados. Archivos descargados.', 'success');

      } catch (error) {
        addLog(logId, `\n‚úó Error: ${error.message}`, 'error');
        showStatus(statusId, `‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Actualizar Todo';
      }
    }

    // Inicializar
    updateCacheInfo();
  </script>
</body>
</html>
